Goal:
Configs marked encrypted = true are unreadable at rest and only decrypted at request time.

Add deps

aes-gcm = "0.10"
base64 = "0.22"
rand = "0.8"


---

src/crypto/encrypt.rs

use aes_gcm::{Aes256Gcm, Key, Nonce};
use aes_gcm::aead::{Aead, KeyInit};
use rand::RngCore;
use base64::{encode, decode};

pub fn encrypt(plaintext: &str, master_key: &[u8]) -> String {
    let key = Key::<Aes256Gcm>::from_slice(master_key);
    let cipher = Aes256Gcm::new(key);

    let mut nonce_bytes = [0u8; 12];
    rand::thread_rng().fill_bytes(&mut nonce_bytes);
    let nonce = Nonce::from_slice(&nonce_bytes);

    let ciphertext = cipher.encrypt(nonce, plaintext.as_bytes()).unwrap();

    format!(
        "{}:{}",
        encode(nonce_bytes),
        encode(ciphertext)
    )
}

pub fn decrypt(ciphertext: &str, master_key: &[u8]) -> String {
    let key = Key::<Aes256Gcm>::from_slice(master_key);
    let cipher = Aes256Gcm::new(key);

    let parts: Vec<&str> = ciphertext.split(':').collect();
    let nonce = Nonce::from_slice(&decode(parts[0]).unwrap());
    let data = decode(parts[1]).unwrap();

    let plaintext = cipher.decrypt(nonce, data.as_ref()).unwrap();
    String::from_utf8(plaintext).unwrap()
}

Env var (required)

CONFIG_HUB_MASTER_KEY=32-byte-base64-key

Now modify:

set_config: encrypt before saving

get_config: decrypt before returning


This gives you Vault-lite behavior with zero infra.
